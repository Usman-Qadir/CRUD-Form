@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<style>
    body {
        background-color: blue;
        background-image: url(https://images.unsplash.com/photo-1526256262350-7da7584cf5eb?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D);
    }

    .card-header {
        width: 100%;
        background-color: #0a4a5b;
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 2px;
        border-radius: 5px;
        cursor: pointer;
    }

    .tb-header{
        background-color: #0a4a5b;
    }



    .form-control, .form-select {
        border-radius: 10px;

        height: 30px;
    }

        .form-control:focus, .form-select:focus {
            border: 1px solid red;
            box-shadow: 0 0 5px red;
        }
</style>
<div>
    <div class="card">
        <div class="card-header">
            <h3 class=" section-header ">Basic Information</h3>
            <i class="fa-solid fa-minus fa-lg"></i>
        </div>

        <div class="card-body">
            <form method="post" id="form1">

                <fieldset class="mb-2">
                    <div class="row">
                        <h6 class="col-md-1 mb-3">Name</h6>
                        <div class="col-md-3 mb-3">
                            <input type="text" class="form-control" id="firstName" min="3" pattern="[A-Za-z]+" title="Only Alphabets and spaces allowed" placeholder="Patient's First Name" required>
                            <div class="error-message" id="firstNameError"></div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <input type="text" class="form-control" id="middleName" pattern="[A-Za-z ]*" title="Only alphabets and spaces allowed" placeholder="Patient's Middle Name">
                        </div>
                        <div class="col-md-3 mb-3">
                            <input type="text" class="form-control" id="lastName" pattern="[A-Za-z ]+" title="Only alphabets and spaces allowed" placeholder="Patient's Last Name" required>
                            <div class="error-message" id="lastNameError"></div>
                        </div>
                    </div>
                </fieldset>


                <fieldset class="mb-2">
                    <div class="row">
                        <h6 class="col-md-1 mb-3">Relation</h6>
                        <div class="col-md-3 mb-3">
                            <select class="form-select">
                                <option value=""></option>
                                <option>Mother</option>
                                <option>Father</option>
                                <option>Brother</option>
                                <option>Sister</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <input type="text" class="form-control" id="relFirstName" placeholder="Relation's First Name" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <input type="text" class="form-control" id=" relLastName" placeholder="Relation's Last Name" required>
                        </div>

                    </div>
                </fieldset>



                <fieldset class="mb-1">
                    <div class="row">
                        <h6 class="col-md-1 mb-3">Gender</h6>
                        <div class="col-md-1 mb-3">
                            <select class="form-select">
                                <option value=""></option>
                                <option>Male</option>
                                <option>Female</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <h6 class="col-md-1 mb-3">DOB</h6>
                        <div class="col-md-2 mb-3">
                            <input type="date" class="form-control" id="DOB" required>
                            <div class="error-message" id="dobError"></div>
                        </div>
                        <h6 class="col-md-1 mb-3">Age</h6>
                        <div class="col-md-1 mb-3">
                            <input type="text" class="form-control" id="ageMonth" placeholder="Month">
                        </div>
                        <div class="col-md-1 mb-3">
                            <input type="text" class="form-control" id="ageDay" placeholder="Day">
                        </div>

                        <div class="col-md-1 mb-3">
                            <input type="text" class="form-control" id="ageYear" placeholder="Year">
                        </div>
                        <h6 class="col-md-1 mb-3">Spousal</h6>
                        <div class="col-md-2 mb-3">
                            <select class="form-select">
                                <option value=""></option>
                                <option>Yes</option>
                                <option>No</option>
                            </select>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <div class="row">
                        <h6 class="col-md-1">CNIC</h6>
                        <div class="col-md-2 mb-3">
                            <input type="text" class="form-control" id="cnic" title="Format: 1234512345671" placeholder="XXXXXXXXXXXXX" required>
                            <div class="error-message" id="cnicError"></div>
                        </div>
                        <h6 class="col-md-1">Owner</h6>
                        <div class="col-md-2">
                            <select class="form-select">
                                <option value=""></option>
                                <option>Self</option>
                                <option>Father</option>
                                <option>Mother</option>

                            </select>
                        </div>
                        <h6 class="col-md-1">Cell#</h6>
                        <div class="col-md-2 mb-3">
                            <input type="text" class="form-control" id="cellNumber" title="Format: 1234-1234567" placeholder="XXXX-XXXXXXX" required>
                            <div class="error-message" id="cellNumberError"></div>
                        </div>
                        <h6 class="col-md-1">Cell Owner</h6>
                        <div class="col-md-2 mb-3">
                            <input type="text" class="form-control" id="cellOwner" required>
                            <div class="error-message" id="cellOwnerError"></div>
                        </div>

                    </div>
                </fieldset>

                <div class="row">
                    <h6 class="col-md-1 mb-3">Dept</h6>
                    <div class="col-md-2 mb-3">
                        <select class=" form-select " id="department" placeholder="Department" required>
                            <option value=""></option>
                            <option>Cardiology</option>
                            <option>Neurology</option>
                            <option>Orthopedics</option>
                            <option>Dermatology</option>
                        </select>

                    </div>
                </div>



                <div class="col-6">
                    <button class="btn btn-primary" type="submit">Submit form</button>
                    <button class="btn btn-primary" type="button" id="downloadJsonBtn">Download JSON</button>
					<button class="btn btn-primary" type="button" id="updateFormBtn">Update Record</button>
					
                </div>



        
            </form>
        </div>
    </div>

    <!------ Table  --->

    <table class = "table table-bordered mt-5 table-light table-responsive ">
        <thead class="table-light">
            <tr>
                <th colspan="8" class="text-center tb-header">Patient's Information</th>
            </tr>
            <tr>
                <th>ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>CNIC</th>
                <th>Department</th>
                <th>DOB</th>
                <th>Contact</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="formEntriesTableBody"></tbody>

    <tr>
        <td></td>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
            <td></td>
            <td></td>
			<td>
				
    </tr>
    </table>











</div>



@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Toggle form section
            $(".card-header").click(function () {
                $(".card-body").slideToggle();
                $(this).find("i").toggleClass("fa-minus fa-plus");
            });

            // Auto-calculate age from DOB
            function calculateAgeFromDOB(dob) {
                let birthDate = new Date(dob);
                let today = new Date();
                let years = today.getFullYear() - birthDate.getFullYear();
                let months = today.getMonth() - birthDate.getMonth();
                let days = today.getDate() - birthDate.getDate();

                if (days < 0) {
                    months--;
                    days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
                }
                if (months < 0) {
                    years--;
                    months += 12;
                }

                $("#ageYear").val(years);
                $("#ageMonth").val(months);
                $("#ageDay").val(days);
            }

            // Auto-calculate DOB from age
            function calculateDOBFromAge() {
                let years = parseInt($("#ageYear").val()) || 0;
                let months = parseInt($("#ageMonth").val()) || 0;
                let days = parseInt($("#ageDay").val()) || 0;

                let today = new Date();
                let dob = new Date(today);

                dob.setFullYear(dob.getFullYear() - years);
                dob.setMonth(dob.getMonth() - months);
                dob.setDate(dob.getDate() - days);

                $("#DOB").val(dob.toISOString().split("T")[0]);
            }

            // Input handlers for DOB/age
            $("#DOB").change(function () {
                calculateAgeFromDOB($(this).val());
            });

            $("#ageYear, #ageMonth, #ageDay").on("input", function () {
                calculateDOBFromAge();
            });

            // Capitalize and validate name inputs
            function validateNameInput(inputField, errorField) {
                let value = $(inputField).val();
                let cleanedValue = value.replace(/[^A-Za-z ]/g, '');
                $(inputField).val(cleanedValue);

                if (cleanedValue.length > 0) {
                    let capitalized = cleanedValue.toLowerCase()
                        .split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                    $(inputField).val(capitalized);
                }
            }

            $("#firstName, #middleName, #lastName").on("input", function () {
                validateNameInput(this, "#" + $(this).attr("id") + "Error");
            });

            // CNIC formatting and validation
            $("#cnic").on("input", function () {
                let rawValue = $(this).val().replace(/\D/g, '');
                rawValue = rawValue.substring(0, 13);
                $(this).val(rawValue);

                $("#cnicError").text(
                    rawValue.length !== 13 ? "CNIC must be exactly 13 digits" : ""
                ).css("color", "red");
            });

            // Cell number formatting and validation
            $("#cellNumber").on("input", function () {
                let rawValue = $(this).val().replace(/\D/g, '');
                rawValue = rawValue.substring(0, 11);
                $(this).val(rawValue);

                if (rawValue.length !== 11) {
                    $("#cellNumberError").text("Cell number must be exactly 11 digits").css("color", "red");
                } else if (!rawValue.startsWith("03")) {
                    $("#cellNumberError").text("Must start with 03").css("color", "red");
                } else {
                    $("#cellNumberError").text("");
                }
            });

            // Main submit functionality
            $("#form1").on("submit", function (event) {
                event.preventDefault();

                let hasErrors = $(".error-message").toArray().some(el => $(el).text().trim() !== "");
                if (hasErrors) {
                    alert("Please fix the errors before submitting.");
                    return;
                }

                const formData = {
                    firstName: $("#firstName").val(),
                    middleName: $("#middleName").val(),
                    lastName: $("#lastName").val(),
					Relation:$("#relation").val(),
					RelativeFirstName: $("#relFirstName").val(),
					RelativeLastName: $("#relLastName").val(),
                    cnic: $("#cnic").val(),
                    cellNumber: $("#cellNumber").val(),
                    cellOwner: $("#cellOwner").val(),
                    dob: $("#DOB").val(),
                    department: $("#department").val()
                };

                const key = `${formData.cnic}`;
                let existingData = JSON.parse(localStorage.getItem("formEntries")) || {};

                //  Check for duplicate CNIC
                if (existingData[key]) {
                    alert("Record with same CNIC and department already exists. Use 'Update Record' if you want to update it.");
                    return;
                }

                existingData[key] = formData;
                localStorage.setItem("formEntries", JSON.stringify(existingData));

                alert("Form data saved locally!");
                $("#form1")[0].reset();
				populateTable();
            });

            // Update record if it exists
            $("#updateFormBtn").on("click", function () {
                const formData = {
                    firstName: $("#firstName").val(),
                    middleName: $("#middleName").val(),
                    lastName: $("#lastName").val(),
                    Relation:$("#relation").val(),
                    RelativeFirstName: $("#relFirstName").val(),
                    RelativeLastName: $("#relLastName").val(),
                    cnic: $("#cnic").val(),
                    cellNumber: $("#cellNumber").val(),
                    cellOwner: $("#cellOwner").val(),
                    dob: $("#DOB").val(),
                    department: $("#department").val()
                };

                const key = `${formData.cnic}`;
                let existingData = JSON.parse(localStorage.getItem("formEntries")) || {};

                if (!existingData[key]) {
                    alert("Record not found. Use Submit form to add it.");
                    return;
                }

                existingData[key] = formData;
                localStorage.setItem("formEntries", JSON.stringify(existingData));

                alert("Record updated successfully!");
                $("#form1")[0].reset();
            });

                    $(document).on("click", ".edit-btn", function () {
            const key = $(this).data("key");
            const data = JSON.parse(localStorage.getItem("formEntries"))[key];

            $("#firstName").val(data.firstName);
            $("#middleName").val(data.middleName);
            $("#lastName").val(data.lastName);
			$("#relation").val(data.Relation);
			$("#relFirstName").val(data.RelativeFirstName);
			$("#relLastName").val(data.RelativeLastName);
            $("#cnic").val(data.cnic);
            $("#cellNumber").val(data.cellNumber);
            $("#cellOwner").val(data.cellOwner);
            $("#DOB").val(data.dob);
            $("#department").val(data.department);

            calculateAgeFromDOB(data.dob);
        });

        $(document).on("click", ".delete-btn", function () {
            const key = $(this).data("key");
            let entries = JSON.parse(localStorage.getItem("formEntries"));
            delete entries[key];
            localStorage.setItem("formEntries", JSON.stringify(entries));
            populateTable();
        });











            // Download JSON
            $("#downloadJsonBtn").on("click", function () {
                const entries = JSON.parse(localStorage.getItem("formEntries")) || {};

                if (Object.keys(entries).length === 0) {
                    alert("No data available to download.");
                    return;
                }

                const blob = new Blob([JSON.stringify(entries, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);

                const a = document.createElement("a");
                a.href = url;
                a.download = "form-entries.json";
                a.click();

                URL.revokeObjectURL(url);
            });



			// Load existing entries into the table
                    function populateTable() {
            const entries = JSON.parse(localStorage.getItem("formEntries")) || {};
            let rows = "";

            Object.entries(entries).forEach(([key, data], index) => {
                rows += `
                    <tr>
                        <td>${index + 1 }</td>
                        <td>${data.firstName}</td>
                        <td>${data.lastName}</td>
                        <td>${data.cnic}</td>
                        <td>${data.department}</td>
                        <td>${data.dob}</td>
                        <td>${data.cellNumber}</td>
                        <td>
                            <button class="btn btn-sm btn-dark edit-btn" data-key="${key}">Edit</button>
                            <button class="btn btn-sm btn-danger delete-btn" data-key="${key}">Delete</button>
                        </td>
                    </tr>
                `;
            });

            $("#formEntriesTableBody").html(rows);
        }

                  // Call it on load
              populateTable();

        });
    </script>
}
